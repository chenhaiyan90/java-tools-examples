package com.dova.dev.dataFix;

import com.dova.dev.common.JSON;
import com.dova.dev.jdbc.ConnectionTool;
import com.google.common.base.Strings;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * Created by liuzhendong on 16/7/12.
 */
public class FixDishMaterial {


    //public final String dishIds = "518195,518199,518260,518333,518334,518336,518343,518344,518346,518349,518352,518357,518358,518359,518361,518362,518363,518364,518365,518366,518367,518369,518371,518372,518373,518374,518375,518377,518378,518388,518390,518415,518421,518426,518428,518429,518437,518438,518439,518474,518489,518491,518492,518494,518506,518517,518521,518524,518526,518534,518536,518540,518543,518544,518546,518547,518549,518557,518566,518574,518596,518600,518601,518603,518604,518608,518614,518625,518626,518640,518651,518658,518680,518693,518697,518701,518732,518738,518744,518745,518770,518799,518805,518812,518815,518857,518861,518873,518874,518883,518896,518903,518911,518948,518959,518960,518962,518968,518990,518997,518998,518999,519000,519001,519012,519014,519024,519074,519075,519084,519088,519089,519090,519103,519319,519346,519349,519597,519603,519605,519639,519644,519724,519814,519910,519988,520176,520294,520379,520383,520393,520489,520495,520509,520518,520526,520579,520594,520629,520633,520716,520718,520722,520723,520787,520791,520795,520805,520807,520811,520813,520815,520816,520823,520895,521110,521125,521140,521141,521144,521148,521178,521180,521185,521187,521193,521194,521198,521199,521200,521211,521224,521227,521257,521261,521263,521265,521266,521270,521272,521273,521277,521322,521333,521343,521344,521347,521354,521355,521356,521358,521361,521385,521409,521427,521453,521479,521481,521497,521512,521517,521583,521827,521856,521862,521865,521866,521868,521870,521874,521929,521940,521950,521963,521976,521999,522007,522030,522043,522045,522046,522051,522053,522056,522097,522114,522116,522118,522122,522136,522140,522155,522170,522174,522177,522194,522196,522198,522200,522202,522204,522209,522230,522258,522262,522263,522268,522273,522280,522281,522283,522284,522310,522311,522313,522314,522317,522342,522346,522352,522353,522354,522361,522365,522369,522375,522388,522393,522400,522403,522404,522408,522419,522424,522425,522427,522429,522430,522434,522437,522439,522440,522446,522448,522449,522451,522454,522481,522491,522493,522501,522502,522504,522506,522513,522516,522517,522518,522519,522530,522531,522535,522536,522538,522540,522543,522544,522546,522553,522571,522573,522575,522576,522578,522580,522581,522583,522584,522586,522587,522591,522595,522625,522631,522652,522655,522657,522658,522694,522697,522699,522701,522702,522704,522708,522720,522732,522746,522750,522752,522757,522758,522762,522771,522789,522790,522803,522825,522838,522839,522840,522841,522842,522849,522946,522982,522986,522993,522997,523002,523005,523065,523080,523086,523087,523092,523107,523143,523163,523165,523167,523168,523169,523175,523214,523300,523301,523303,523316,523360,523361,523362,523387,523392,523393,523395,523398,523401,523406,523413,523426,523430,523431,523435,523439,523450,523490,523631,523705,523707,523717,523723,523727,523766,523791,523794,523797,523799,523800,523804,523805,523820,523856,523857,523866,523867,523878,523879,523882,523884,524006,524007,524008,524054,524056,524059,524123,524124,524142,524202,524204,524206,524209,524210,524247,524251,524252,524253,524255,524317,524326,524335,524339,524357,524359,524362,524387,524404,524432,524442,524447,524449,524452,524457,524498,524506,524557,524605,524606,524610,524662,524667,524677,524678,524679,524682,524684,524686,524688,524689,524690,524701,524717,524755,524756,524757,524832,524833,524868,524895,524898,524958,524960,525028,525149,525322,525335,525353,525502,525558,525562,525660,525686,525687,525689,525690,525691,525692,525694,525695,525746,525779,525845,525851,526015,526021,526080,526081,526097,526119,526120,526130,526149,526164,526168,526184,526206,526408,526484,526487,526522,526527,526578,526639,526656,526660,526738,526799,526822,526824,526827,526916,527021,527028,527032,527040,527085,527088,527090,527092,527174,527270,527273,527276,527503,527531,527575,527579,527585,527629,527632,527648,527650,527652,527675,527738,527748,527749,527750,527752,527753,527808,527866,527873,527876,527878,528041,528042,528105,528226,528227,528230,528231,528514,528575,528579,528622,528634,528647,528668,528745,528814,528878,528954,528988,529013,529015,529043,529046,529049,529051,529053,529054,529056,529060,529068,529138,529148,529162,529181,529192,529203,529233,529368,529370,529690,529778,529790,529795,529856,529858,529879,529889,529922,529945,529954,530033,530035,530048,530134,530136,530144,530146,530151,530152,530154,530155,530170,530174,530268,530269,530272,530274,530276,530278,530280,530308,530309,530311,530312,530346,530348,530351,530401,530404,530408,530414,530415,530418,530419,530421,530425,530426,530427,530428,530429,530430,530431,530433,530442,530445,530459,530466,530475,530506,530507,530510,530530,530533,530535,530547,530548,530551,530565,530572,530573,530574,530576,530580,530610,530612,530615,530618,530683,530686,530706,530711,530713,530717,530763,530837,530858,530867,530868,530876,530877,530891,530947,531001,531015,531017,531022,531044,531052,531053,531055,531063,531072,531073,531123,531125,531127,531129,531132,531134,531135,531147,531148,531157,531166,531174,531175,531176,531179,531181,531218,531221,531224,531237,531275,531278,531281,531321,531322,531324,531325,531326,531334,531335,531342,531369,531370,531371,531373,531374,531376,531393,531396,531397,531401,531402,531406,531407,531411,531417,531422,531467,531479,531495,531497,531498,531499,531501,531502,531504,531506,531507,531508,531509,531510,531541,531559,531560,531561,531563,531564,531567,531569,531574,531586,531587,531619,531622,531626,531651,531728,531730,531732,531733,531738,531763,531780,531785,531805,531829,531852,531867,531905,531907,531995,532053,532098,532099,532102,532108,532118,532149,532154,532158,532161,532178,532179,532192,532194,532225,532227,532229,532240,532250,532331,532335,532337,532340,532344,532428,532430,532439,532441,532454,532455,532551,532552,532560,532578,532582,532584,532590,532593,532627,532631,532650,532655,532667,532673,532684,532712,532718,532733,532737,532739,532740,532784,532788,532793,532802,532814,532824,532839,532862,532870,532871,532873,532893,532894,532975,532984,532985,532989,532991,532993,533013,533014,533016,533046,533047,533050,533064,533066,533077,533085,533086,533088,533121,533125,533126,533257,533327,533462,533463,533465,533602,533632,533638,533639,534062,534190,534252,534254,534267,534382,534630,534637,534695,534697,534698,534705,534730,534967,535054,535095,535102,535220,535222,535265,535310,535311,535314,535316,535320,535322,535326,535329,535696,535880,535886,535911,535912,535914,535916,535921,535922,535923,535934,535937,535941,535944,535945,535959,535960,535963,535966,535970,535971,535973,535976,535986,536051,536052,536184,536185,536186,536187,536188,536189,536190,536192,536279";

    public static final String dishIds = "4832,4839";

    public static void fix()throws SQLException{
        Connection connection = ConnectionTool.createConnection("jdbc:mysql://101.200.143.50:3306/jskz_2.0?characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&tinyInt1isBit=false",
                "root","JSKZ-fc4b679d0%");
        if(connection == null){
            System.out.println("建立连接失败");
            return;
        }

        connection.setAutoCommit(true);
        String getById = "select * from food_kitchen_dish where id = ? ";
        String update = "update food_kitchen_dish set materials = ? where id = ?";
        PreparedStatement getPs = connection.prepareStatement(getById);
        PreparedStatement updatePs = connection.prepareStatement(update);
        String[] ids = dishIds.split(",");
        for(String id: ids){
            if(id.length() == 0) continue;
            Long dishId = Long.valueOf(id);
            getPs.clearParameters();
            getPs.setLong(1,dishId);
            ResultSet resultSet = getPs.executeQuery();
            if(!resultSet.next()){
                System.out.println(dishId +":dish does not exist");
            }
            String materialStr = resultSet.getString("materials");
            if(Strings.isNullOrEmpty(materialStr)) {
                System.out.println(dishId + ":dish material is null or empty");
                continue;
            }

            List<DishMaterial> materials = JSON.safeReadList(materialStr,DishMaterial.class);
            String newstr = JSON.safeToJson(fixMaterail(materials));
            updatePs.clearParameters();
            updatePs.setString(1,newstr);
            updatePs.setLong(2,dishId);
            int res = updatePs.executeUpdate();
            if(res !=1){
                System.out.println(dishId + ":update fail ");
            }else {
                System.out.println(dishId + ":update succ ");
            }

        }
     }

    public static List<DishMaterial> fixMaterail(List<DishMaterial> origins){
        List<DishMaterial> res = new ArrayList<>();
        for(DishMaterial dishMaterial : origins){
            if(Strings.isNullOrEmpty(dishMaterial.getVolume())){
                res.add(dishMaterial);
                continue;
            }
            if(dishMaterial.getVolume().contains("0")
                    ||dishMaterial.getVolume().contains("1")
                    ||dishMaterial.getVolume().contains("2")
                    ||dishMaterial.getVolume().contains("3")
                    ||dishMaterial.getVolume().contains("4")
                    ||dishMaterial.getVolume().contains("5")
                    ||dishMaterial.getVolume().contains("6")
                    ||dishMaterial.getVolume().contains("7")
                    ||dishMaterial.getVolume().contains("8")
                    ||dishMaterial.getVolume().contains("9")){
                res.add(dishMaterial);
                continue;
            }
            DishMaterial tmp = new DishMaterial();
            tmp.setName(dishMaterial.getVolume());
            tmp.setVolume("");
            dishMaterial.setVolume("");
            res.add(dishMaterial);
            res.add(tmp);
        }
        return res;
    }


    public static void main(String[] args)throws Exception{
        fix();
    }
}
